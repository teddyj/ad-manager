<!-- Generated by SpecStory -->

# Campaigns not saving to production database (2025-07-04 01:16Z)

_**User**_

when i create a campaign on production, it doesn't get saved to the database. I don't see the record in supabase, and after. I do see the new campiagn in the campaign manager after completing the step, but it does not persist if i come to the campaign manager in a new browser. can you verify that campaigns are being saved to the database on production

---

_**Assistant**_

<details>
            <summary>Searched codebase "Where is a new campaign saved to the database?" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `api/campaigns.js` | L52-100 |
| `server.cjs` | L327-363 |
| `src/App.jsx` | L3119-3166 |
| `src/App.jsx` | L2740-2786 |
| `src/flows/v2/steps/PublishManager.jsx` | L319-345 |
| `server.cjs` | L396-433 |
| `src/services/databaseAdapter.js` | L522-551 |
| `src/flows/v2/steps/PublishManager.jsx` | L283-319 |
| `db.md` | L144-198 |
| `src/flows/v2/CampaignFlowV2.jsx` | L457-517 |
| `prisma/dev-schema.prisma` | L99-137 |
| `src/services/database.js` | L239-269 |
| `src/flows/v2/CampaignFlowV2.jsx` | L352-383 |
| `src/services/database.js` | L159-192 |
| `src/App.jsx` | L5495-5552 |
| `src/services/databaseAdapter.js` | L317-350 |
| `src/flows/v2/CampaignFlowV2.jsx` | L265-301 |
| `prisma/production-schema.prisma` | L107-151 |
| `api/campaign-draft.js` | L50-100 |
| `prisma/schema.prisma` | L107-151 |
| `prisma/schema.prisma` | L151-192 |
| `src/flows/v2/CampaignFlowV2.jsx` | L734-767 |
| `src/App.jsx` | L5463-5495 |
| `prisma/dev-schema.prisma` | L137-194 |
| `campaign_flow.md` | L730-776 |

</details>

---

Based on the codebase, here’s what’s happening with campaign saving and why you’re not seeing campaigns persist in production:

### 1. **How Campaigns Are Saved**
- The main campaign save logic (for the new Campaign Flow V2) calls `dbOperations.saveAd(data)` (see `src/flows/v2/CampaignFlowV2.jsx` and `src/flows/v2/steps/PublishManager.jsx`).
- The implementation of `saveAd` in production should save to the database, but...

### 2. **What Actually Happens in Production**
- The API endpoints in `api/campaigns.js` and `server.cjs` **save campaigns to the local file system** (in a `tmp/campaigns` directory), not to Supabase or any SQL database.
- There is no code in these API endpoints that writes to Supabase or a remote database. They use `fs.writeFileSync` to save JSON files locally on the server.

### 3. **Why You See Campaigns Temporarily**
- When you create a campaign, it is saved to a file on the server (or possibly to localStorage in the browser, depending on the flow).
- The Campaign Manager loads campaigns from this temporary storage, so you see them immediately after creation.
- **But:** If you open the Campaign Manager in a new browser or after a server restart, those campaigns are not loaded from a persistent, shared database (like Supabase), so they disappear.

### 4. **Database Schema Exists, But Not Used**
- There are Prisma and SQL schemas for a `campaigns` table in Supabase (see `prisma/schema.prisma`, `db.md`), but the production API does **not** use them for saving campaigns.

---

## **Conclusion**
**Campaigns are NOT being saved to the database on production.**  
They are saved to the local file system, which is not persistent or shared across server instances or restarts.

---

## **What Needs to Change**
- The production API (`api/campaigns.js` or the relevant server handler) must be updated to save campaigns to Supabase (or your production database) using the appropriate client (e.g., Prisma or Supabase JS client).
- The current file-based approach is only suitable for local development or testing.

Would you like a step-by-step plan or code to update your production API to save campaigns to Supabase?

---

_**User**_

yes

---

_**Assistant**_

Here’s a step-by-step plan to update your production campaign save logic so that campaigns are saved to Supabase (or your production database) instead of the local file system.

---

## **Step-by-Step Plan**

### **1. Decide Where to Implement Database Save**
- You should update the API endpoint that handles campaign saves. This is likely in `api/campaigns.js` (if using Next.js API routes) or in your Express handler in `server.cjs`.

### **2. Set Up Database Client**
- If you use Prisma, ensure it’s configured for production and can connect to Supabase.
- If you use the Supabase JS client, ensure it’s initialized with your Supabase URL and service key.

### **3. Update the POST Handler**
- Replace the file system save logic with a call to your database to create a new campaign record.

### **4. Map Incoming Data to Database Schema**
- Ensure the data you receive from the client matches your database schema (see `prisma/schema.prisma` or `db.md`).

### **5. Return the Saved Campaign**
- After saving, return the campaign data (or an error) in the API response.

---

## **Example: Using Prisma in `api/campaigns.js`**

Below is a high-level example of how you might update your API route to use Prisma to save to Supabase:

```js
// api/campaigns.js

import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();

export default async function handler(req, res) {
  if (req.method === 'POST') {
    const campaignData = req.body;

    // Map incoming data to your schema fields
    try {
      const newCampaign = await prisma.campaign.create({
        data: {
          // Map fields as needed
          userId: campaignData.userId, // Make sure to provide this
          name: campaignData.name,
          type: campaignData.type,
          status: campaignData.status || 'draft',
          budget: campaignData.budget,
          currency: campaignData.currency || 'USD',
          startsAt: campaignData.startsAt,
          endsAt: campaignData.endsAt,
          audienceConfig: campaignData.audienceConfig || {},
          platformConfig: campaignData.platformConfig || {},
          creativeConfig: campaignData.creativeConfig || {},
          publishConfig: campaignData.publishConfig || {},
          legacyData: campaignData.legacyData || {},
          source: campaignData.source || 'v2',
        }
      });
      res.status(200).json({ success: true, campaign: newCampaign });
    } catch (error) {
      console.error('❌ Failed to save campaign:', error);
      res.status(500).json({ success: false, error: error.message });
    }
  } else {
    res.status(405).json({ error: 'Method not allowed' });
  }
}
```

---

## **What You Need to Do**

1. **Install Prisma Client** (if not already):
   ```sh
   npm install @prisma/client
   ```

2. **Configure your environment** with the correct database URL for Supabase.

3. **Update your API handler** as shown above.

4. **Test campaign creation** in production and verify records appear in Supabase.

---

## **Next Steps**
- Would you like me to generate a full code edit for your `api/campaigns.js` file?
- Or do you want this logic in your Express server (`server.cjs`) instead?

Let me know your preferred backend entry point, and I’ll generate the exact code for you!

---

